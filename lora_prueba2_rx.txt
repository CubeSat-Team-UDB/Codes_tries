#include <Arduino.h>
#include <RadioLib.h>

int pin_cs = PIN_SPI_SS;
int pin_dio0 = D0;
int pin_tx_enable = PWM0;
int pin_rx_enable = G0;
int pin_nrst = G1;
int pin_dio1 = G2;

SX1276 radio = new Module(pin_cs, pin_dio0, pin_nrst, pin_dio1);

void setup() {
  Serial.begin(115200);
  delay(1000);

  Serial.print(F("[RX] Inicializando LoRa... "));
  int state = radio.begin(915.0, 125.0, 9, 7, 0x34, 10, 8, 0);
  if (state == RADIOLIB_ERR_NONE) {
    Serial.println(F("¡Listo!"));
  } else {
    Serial.print(F("Falló, código: "));
    Serial.println(state);
    while (true);
  }

  radio.setDio1Action(onReceive);
  radio.startReceive();
}

void loop() {
  // No hacemos nada en loop, todo es por interrupciones
}

// Manejador cuando se recibe algo
void onReceive() {
  String msg = radio.readString();
  msg.trim();

  Serial.print("[RX] Recibido: ");
  Serial.println(msg);

  // Enviar ACK
  int state = radio.transmit("ACK");
  if (state == RADIOLIB_ERR_NONE) {
    Serial.println("[RX] ACK enviado.");
  } else {
    Serial.println("[RX] Error al enviar ACK.");
  }

  // Reanudar recepción
  radio.startReceive();
}
